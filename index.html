<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Tavubingo</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 30px; }
    .grid { display: grid; gap: 5px; justify-content: center; margin: 20px auto; }
    .cell {
      width: 80px; height: 80px;
      font-size: 24px; font-weight: bold;
      border: 1px solid #999; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; background: white;
    }
    .cell.selected { background: lightblue; }
    .cell.correct { background: lightgreen; }
    .cell.wrong { background: red; color: white; animation: blink 0.4s 2; }
    @keyframes blink { 50% { background: white; color: red; } }
    @keyframes button-blink { 0% { background-color: #ff0; } 50% { background-color: #fff; } 100% { background-color: #ff0; } }
    #word { font-size: 32px; margin: 10px; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
    .speak-btn, .define-btn {
      font-size: 20px; margin-left: 8px; cursor: pointer;
    }
    .blink-button {
      animation: button-blink 1s infinite;
    }
    /* Modal */
    #statsModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
    }
    #statsContent {
      background: #fff; padding: 20px; border-radius: 10px;
      max-width: 400px; margin: 15% auto; text-align: left;
    }
    #closeModal {
      float: right; cursor: pointer; font-size: 20px; font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 id="title">Tavubingo</h1>
  <div id="word">Ladataan sanalista...</div>
  <div class="grid" id="grid"></div>
  <div id="gridInfo"></div>
  <button id="continueBtn" onclick="checkSelection()">Jatka</button>
  <button onclick="endGame()">Lopeta</button>

  <!-- Modal dialog -->
  <div id="statsModal">
    <div id="statsContent">
      <span id="closeModal">&times;</span>
      <h2>Pelitilastot</h2>
      <div id="statsText"></div>
    </div>
  </div>

  <script>
    let tavulista = [];
    let taajuudet = {};
    let grid = [];
    let correctTavut = [];
    let gridSize = 3;
    let gameEnded = true;
    let usedWords = new Set();
    let fileLoaded = false;
    let currentWordCount = 0;
    let latestWord = "";
    let keskimaarainenTavupaino = 0;
    let tavoitePaino = 0;
    let statsString = "";

    // Modal references
    const modal = document.getElementById("statsModal");
    const statsText = document.getElementById("statsText");
    document.getElementById("title").addEventListener("click", () => {
      statsText.innerHTML = statsString;
      modal.style.display = "block";
    });
    document.getElementById("closeModal").onclick = () => { modal.style.display = "none"; };
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

    // ðŸ”„ Lataa sanasto automaattisesti
    fetch('sanat_s2.txt')
      .then(response => response.text())
      .then(data => {
        tavulista = data.split("\n").map(l => l.trim()).filter(Boolean);
        laskeTaajuudet();
        fileLoaded = true;
        startNewGame();
      })
      .catch(error => {
        document.getElementById("word").textContent = "Virhe sanaston latauksessa!";
        console.error(error);
      });

function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "fi-FI";
  utterance.rate = 0.8;
  speechSynthesis.speak(utterance);
}

function laskeTaajuudet() {
  const freq = {};
  let tavuMaara = 0;
  for (let sana of tavulista) {
    const tavut = sana.split("-");
    for (let t of tavut) {
      freq[t] = (freq[t] || 0) + 1;
      tavuMaara++;
    }
  }
  
  taajuudet = Object.fromEntries(Object.entries(freq).filter(([t, n]) => n > 1));

  const summaKaikki = Object.values(freq).reduce((a, b) => a + b, 0);
  const keskiKaikki = summaKaikki / Object.keys(freq).length;
  keskimaarainenTavupaino = keskiKaikki;

  tavoitePaino = keskimaarainenTavupaino * (gridSize * gridSize) * 6;

  statsString = `Sanoja: ${tavulista.length}<br>Tavujen lkm: ${tavuMaara}<br>Erilaisia tavuja: ${Object.keys(freq).length}<br>KeskimÃ¤Ã¤rÃ¤inen tavupaino: ${keskimaarainenTavupaino.toFixed(2)}<br>Tavoitepaino: ${tavoitePaino.toFixed(1)}`;
}

function startNewGame() {
  if (!fileLoaded) return;
  gameEnded = false;
  correctTavut = [];
  usedWords.clear();
  currentWordCount = 0;
  createGrid();
  document.getElementById("continueBtn").classList.remove("blink-button");
  setTimeout(chooseWord, 1800);
}

function weightedUniqueSample(count) {
  const entries = Object.entries(taajuudet);
  entries.sort((a, b) => b[1] - a[1]);
  const topEntries = entries.slice(0, Math.ceil(entries.length * 0.6));
  const result = new Set();
  while (result.size < count && result.size < topEntries.length) {
    const total = topEntries.reduce((s, [k, v]) => s + v, 0);
    let r = Math.random() * total;
    for (const [t, w] of topEntries) {
      if (result.has(t)) continue;
      r -= w;
      if (r <= 0) {
        result.add(t);
        break;
      }
    }
  }
  const resultArray = Array.from(result);
  if (gridSize === 3) {
    resultArray.sort((a, b) => (taajuudet[b] || 0) - (taajuudet[a] || 0));
    const sorted = Array(gridSize * gridSize).fill("");
    const positions = [4, 0, 2, 6, 8, 1, 3, 5, 7];
    for (let i = 0; i < resultArray.length && i < positions.length; i++) {
      sorted[positions[i]] = resultArray[i];
    }
    return sorted;
  }
  return resultArray;
}

function createGrid() {
  const g = document.getElementById("grid");
  g.innerHTML = "";
  g.style.gridTemplateColumns = `repeat(${gridSize}, 80px)`;
  grid = [];
  const n = gridSize * gridSize;

  let tavut = [];
  let totalWeight = 0;

  let attempts = 0;
  do {
    tavut = weightedUniqueSample(n);
    totalWeight = tavut.reduce((sum, t) => sum + (taajuudet[t] || 0), 0);
    attempts++;
  } while (totalWeight < tavoitePaino * 0.8 && attempts < 50);

  for (let i = 0; i < n; i++) {
    const tavu = tavut[i] || "";
    const div = document.createElement("div");
    div.className = "cell";
    div.textContent = tavu.padEnd(4, " ");
    div.dataset.tavu = tavu;
    div.addEventListener("click", () => {
      if (!gameEnded && !div.classList.contains("correct")) {
        div.classList.toggle("selected");
      }
    });
    g.appendChild(div);
    grid.push(div);
  }
  statsString += `<br>Ruudukon paino: ${totalWeight}`;
}

function chooseWord() {
  if (tavulista.length === 0) return;
  const unusedWords = tavulista.filter(s => !usedWords.has(s));
  if (unusedWords.length === 0) {
    document.getElementById("word").textContent = "Kaikki sanat kÃ¤ytetty!";
    return;
  }
  const sanaPainot = unusedWords.map(s => s.split("-").reduce((sum, t) => sum + (taajuudet[t] || 1), 0));
  const total = sanaPainot.reduce((a, b) => a + b, 0);
  let r = Math.random() * total;

  for (let i = 0; i < unusedWords.length; i++) {
    r -= sanaPainot[i];
    if (r <= 0) {
      correctTavut = unusedWords[i].split("-");
      usedWords.add(unusedWords[i]);
      currentWordCount++;
      latestWord = unusedWords[i].replace(/-/g, '');
      latestWord = latestWord.replace(/â€”/g, '-');
      const kotusLink = `https://www.kielitoimistonsanakirja.fi/#/${latestWord}`;
      document.getElementById("word").innerHTML = `<b>${latestWord}</b> [${currentWordCount}] <button class='speak-btn' onclick=\"speak(latestWord)\">ðŸ”Š</button> <a href='${kotusLink}' target='_blank'><button class='define-btn'>ðŸ“–</button></a>`;
      speak(latestWord);
      return;
    }
  }
}

function checkSelection() {
  if (gameEnded) {
    gameEnded = false;
    document.getElementById("continueBtn").classList.remove("blink-button");
    createGrid();
    setTimeout(chooseWord, 1800);
    return;
  }
  if (gameEnded) return;
  let animated = false;
  for (const cell of grid) {
    const t = cell.dataset.tavu;
    if (cell.classList.contains("selected")) {
      if (correctTavut.includes(t)) {
        cell.classList.remove("selected");
        cell.classList.add("correct");
      } else {
        cell.classList.remove("selected");
        cell.classList.add("wrong");
        setTimeout(() => {
          cell.classList.remove("wrong");
        }, 800);
        animated = true;
      }
    }
  }

  if (checkVictory()) {
    highlightBingo();
    gameEnded = true;
    usedWords.clear();
    speak("Bingo");
    document.getElementById("word").innerHTML = `<span style='font-size: 32px;'>Bingo!</span> <span style='font-size: 20px;'>[ ${currentWordCount} sanaa arvottu]</span>`;
    currentWordCount = 0;
    document.getElementById("continueBtn").classList.add("blink-button");
    return;
  } else {
    for (const cell of grid) {
      const t = cell.dataset.tavu;
      if (correctTavut.includes(t) && !cell.classList.contains("correct")) {
        cell.style.background = "gold";
        cell.style.animation = "blink 0.5s 3";
        setTimeout(() => {
          cell.style.background = "";
          cell.style.animation = "";
          cell.classList.remove("selected");
        }, 1500);
        animated = true;
      }
    }
    if (animated) {
      setTimeout(chooseWord, 1800);
    } else {
      chooseWord();
    }
  }
}

function checkVictory() {
  const isCorrect = i => grid[i].classList.contains("correct");
  const lines = [];
  for (let r = 0; r < gridSize; r++) lines.push([...Array(gridSize).keys()].map(c => r * gridSize + c));
  for (let c = 0; c < gridSize; c++) lines.push([...Array(gridSize).keys()].map(r => r * gridSize + c));
  lines.push([...Array(gridSize).keys()].map(i => i * (gridSize + 1)));
  lines.push([...Array(gridSize).keys()].map(i => (i + 1) * (gridSize - 1)));
  return lines.some(line => line.every(i => isCorrect(i)));
}

function endGame() {
  gameEnded = true;
  currentWordCount = 0;
  usedWords.clear();
  document.getElementById("word").textContent = "Peli lopetettu.";
  document.getElementById("continueBtn").classList.add("blink-button");
}

function highlightBingo() {
  const isCorrect = i => grid[i].classList.contains("correct");
  const lines = [];
  for (let r = 0; r < gridSize; r++) lines.push([...Array(gridSize).keys()].map(c => r * gridSize + c));
  for (let c = 0; c < gridSize; c++) lines.push([...Array(gridSize).keys()].map(r => r * gridSize + c));
  lines.push([...Array(gridSize).keys()].map(i => i * (gridSize + 1)));
  lines.push([...Array(gridSize).keys()].map(i => (i + 1) * (gridSize - 1)));
  for (const line of lines) {
    if (line.every(i => isCorrect(i))) {
      for (const i of line) {
        grid[i].style.animation = "blink 0.4s 4";
      }
      break;
    }
  }
}
  </script>
</body>
</html>
